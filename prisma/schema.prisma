generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// -----------------------------------------------------------------------------
// Admin / Management
// -----------------------------------------------------------------------------

model AdminUser {
  id             String   @id @default(uuid())
  supabaseUserId String   @unique @map("supabase_user_id")
  email          String   @unique
  role           Role     @default(OPERATOR)
  isActive       Boolean  @default(true) @map("is_active")
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  importLogs     ImportLog[]

  @@map("admin_users")
}

enum Role {
  ADMIN
  OPERATOR
}

// -----------------------------------------------------------------------------
// Municipality Data
// -----------------------------------------------------------------------------

model Municipality {
  id               String      @id @default(uuid())
  jisCode          String      @unique @map("jis_code") // PK代わり
  name             String
  
  // Region / Slug
  prefectureCode   String      @map("prefecture_code") // 01-47
  prefectureName   String      @map("prefecture_name") // 検索用非正規化
  prefectureSlug   String      @map("prefecture_slug") // slug: "tokyo"
  municipalitySlug String      @map("municipality_slug") // slug: "shinjuku-ku"
  region           String?     // e.g. "kanto", "tohoku" (検索・タブ用)

  // URLs
  url              String?     // 公式HP
  pdfUrl           String?     @map("pdf_url") // 申請書PDF

  // Status Management
  isPublished      Boolean     @default(true) @map("is_published")
  linkStatus       LinkStatus  @default(UNKNOWN) @map("link_status")
  lastCheckedAt    DateTime?   @map("last_checked_at")
  
  // Content / SEO
  notes            String?     // 管理メモ
  seoDescription   String?     @map("seo_description")

  // Relations
  auditLogs        AuditLog[]

  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  @@index([prefectureCode])
  @@index([prefectureSlug, municipalitySlug])
  @@map("municipalities")
}

// -----------------------------------------------------------------------------
// Import / System Logs
// -----------------------------------------------------------------------------

model ImportLog {
  id           String      @id @default(uuid())
  // Use loose relation or just ID if AdminUser isn't strictly needed for FK, 
  // but let's try to link it if AdminUser is the actor.
  // Since AdminUser is our internal auth table:
  adminUserId  String      @map("admin_user_id")
  adminUser    AdminUser   @relation(fields: [adminUserId], references: [id])

  filename     String
  fileType     String?     @map("file_type") // csv or json
  totalCount   Int         @map("total_count")
  successCount Int         @map("success_count")
  failedCount  Int         @map("failed_count")
  
  // Optional: Store detailed error log as JSON
  errorLog     String?     @map("error_log") // JSON string or text

  createdAt    DateTime    @default(now()) @map("created_at")

  @@map("import_logs")
}

enum LinkStatus {
  OK
  NEEDS_REVIEW
  BROKEN
  UNKNOWN
}

// -----------------------------------------------------------------------------
// Inquiry / Form Data
// -----------------------------------------------------------------------------

model Inquiry {
  id                  String              @id @default(uuid())
  status              InquiryStatus       @default(NEW)
  
  // Personal Info
  lastName            String              @map("last_name")
  firstName           String              @map("first_name")
  lastNameKana        String              @map("last_name_kana")
  firstNameKana       String              @map("first_name_kana")
  email               String
  phone               String
  
  // Address
  postalCode          String              @map("postal_code")
  prefecture          String
  city                String
  addressDetail       String?             @map("address_detail")

  // Survey / Details
  cemeteryType        CemeteryType        @map("cemetery_type")
  considerationPeriod ConsiderationPeriod @map("consideration_period")
  content             String
  
  // Optional Services
  destinationType     DestinationType?    @map("destination_type")
  boneServiceType     BoneServiceType?    @map("bone_service_type")
  containerType       ContainerType?      @map("container_type")
  ritanConsultation   Boolean?            @map("ritan_consultation")

  // System / Meta
  memo                String?             // 管理メモ
  ipAddress           String?             @map("ip_address")
  userAgent           String?             @map("user_agent")
  
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  @@map("inquiries")
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  DONE
  ARCHIVED
}

enum CemeteryType {
  TEMPLE      // 寺院墓地
  PUBLIC      // 公営霊園
  PRIVATE     // 民営霊園
  COMMUNITY   // 共同墓地
  OTHER       // その他
  UNKNOWN     // 不明
}

enum ConsiderationPeriod {
  IMMEDIATE   // すぐにでも
  WITHIN_HALF_YEAR // 半年以内
  WITHIN_YEAR      // 1年以内
  UNDECIDED        // 未定
}

enum DestinationType {
  NEW_GRAVE   // 新しいお墓
  NOUKOTSUDO  // 納骨堂
  TREE_BURIAL // 樹木葬
  SCATTERING  // 散骨
  HOME        // 手元供養
  OTHER
}

enum BoneServiceType {
  POWDER      // 粉骨
  WASH        // 洗骨
  BOTH        // 両方
  NONE        // 不要
}

enum ContainerType {
  SEALED_BAG  // 密封袋
  URN         // 骨壷
  ORIGINAL_BOX // オリジナル骨箱
  BONE_BAG    // 骨袋
  UNDECIDED   // 未定
}

// -----------------------------------------------------------------------------
// System Logs
// -----------------------------------------------------------------------------

model AuditLog {
  id             BigInt       @id @default(autoincrement())
  municipalityId String       @map("municipality_id")
  targetUrl      String       @map("target_url")
  httpStatus     Int?         @map("http_status")
  result         AuditResult  @map("result") // OK, NG (Enum化)
  errorMessage   String?      @map("error_message")
  checkedAt      DateTime     @default(now()) @map("checked_at")

  municipality   Municipality @relation(fields: [municipalityId], references: [id])

  @@index([municipalityId])
  @@map("audit_logs")
}

enum AuditResult {
  OK
  REDIRECT
  CLIENT_ERROR
  SERVER_ERROR
  TIMEOUT
  DNS_ERROR
  UNKNOWN_ERROR
}
