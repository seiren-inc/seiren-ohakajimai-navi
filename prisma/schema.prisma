generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AdminUser {
  id             String      @id @default(uuid())
  supabaseUserId String      @unique @map("supabase_user_id")
  email          String      @unique
  role           Role        @default(OPERATOR)
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  importLogs     ImportLog[]

  @@map("admin_users")
}

model Municipality {
  id               String     @id @default(uuid())
  jisCode          String     @unique @map("jis_code")
  name             String
  prefectureCode   String     @map("prefecture_code")
  prefectureName   String     @map("prefecture_name")
  prefectureSlug   String     @map("prefecture_slug")
  municipalitySlug String     @map("municipality_slug")
  region           String?
  url              String?
  pdfUrl           String?    @map("pdf_url")
  isPublished      Boolean    @default(true) @map("is_published")
  linkStatus       LinkStatus @default(UNKNOWN) @map("link_status")
  lastCheckedAt    DateTime?  @map("last_checked_at")
  notes            String?
  linkType         LinkType   @default(GUIDE) @map("link_type")
  seoDescription   String?    @map("seo_description")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  hasDomainWarning Boolean    @default(false) @map("has_domain_warning")
  subLinks         Json?      @map("sub_links")
  dataQualityLevel Int        @default(0) @map("data_quality_level")
  auditLogs        AuditLog[]

  @@unique([prefectureCode, municipalitySlug])
  @@index([prefectureCode])
  @@index([prefectureSlug, municipalitySlug])
  @@index([linkStatus])
  @@map("municipalities")
}

model MunicipalityArchive {
  id               String     @id
  jisCode          String     @map("jis_code")
  name             String
  prefectureCode   String     @map("prefecture_code")
  prefectureName   String     @map("prefecture_name")
  prefectureSlug   String     @map("prefecture_slug")
  municipalitySlug String     @map("municipality_slug")
  region           String?
  url              String?
  pdfUrl           String?    @map("pdf_url")
  isPublished      Boolean    @map("is_published")
  linkStatus       LinkStatus @map("link_status")
  lastCheckedAt    DateTime?  @map("last_checked_at")
  notes            String?
  seoDescription   String?    @map("seo_description")
  createdAt        DateTime   @map("created_at")
  updatedAt        DateTime   @map("updated_at")
  hasDomainWarning Boolean    @map("has_domain_warning")
  linkType         LinkType   @map("link_type")
  subLinks         Json?      @map("sub_links")
  dataQualityLevel Int        @default(0) @map("data_quality_level")
  archivedAt       DateTime   @default(now()) @map("archived_at")

  @@map("municipalities_archive")
}

// --- 行政書士マッチング ---

enum InquiryType {
  OHaka
  GYoseishoshi
}

// Doc-35 + 実行計画に統一: BASIC / STANDARD / PREMIUM
enum ScrivenerPlanType {
  BASIC
  STANDARD
  PREMIUM
}

// Doc-10 §8, Doc-16 §5: 支払いステータス
enum PaymentStatus {
  UNPAID
  PAID
  SUSPENDED
}

model AdministrativeScrivener {
  id                 String             @id @default(cuid())
  officeName         String             @map("office_name")
  representativeName String?            @map("representative_name")
  registrationNumber String?            @map("registration_number") // Doc-16 §3: 登録番号
  prefecture         String
  city               String?
  addressLine        String?            @map("address_line")
  phone              String?
  email              String?
  websiteUrl         String?            @map("website_url")
  priceRangeText     String?            @map("price_range_text")
  specialties        String[]           @default([])
  profileText        String             @map("profile_text")
  businessHours      String?            @map("business_hours") // Doc-16 §3: 営業時間
  planType           ScrivenerPlanType  @default(BASIC) @map("plan_type")
  priorityScore      Int                @default(0) @map("priority_score")
  isApproved         Boolean            @default(false) @map("is_approved")
  isActive           Boolean            @default(true) @map("is_active")
  complaintFlag      Boolean            @default(false) @map("complaint_flag") // Doc-18 §7: 苦情フラグ
  paymentStatus      PaymentStatus      @default(UNPAID) @map("payment_status") // Doc-10 §8
  contractStartDate  DateTime?          @map("contract_start_date") // Doc-18 §5
  contractEndDate    DateTime?          @map("contract_end_date")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  inquiries          Inquiry[]
  auditLogs          ScrivenerAuditLog[]

  @@index([prefecture, isApproved, isActive])
  @@index([planType, priorityScore])
  @@index([isApproved, isActive])
  @@index([paymentStatus])
  @@map("administrative_scriveners")
}

// Doc-16 §8, Doc-17 §8: 監査ログ（削除禁止）
model ScrivenerAuditLog {
  id            String                  @id @default(cuid())
  scrivenerId   String                  @map("scrivener_id")
  scrivener     AdministrativeScrivener @relation(fields: [scrivenerId], references: [id], onDelete: Cascade)
  actionType    String                  @map("action_type") // APPROVE / SUSPEND / UPDATE / PLAN_CHANGE / PAYMENT_UPDATE
  beforeValue   Json?                   @map("before_value")
  afterValue    Json?                   @map("after_value")
  adminUserId   String                  @map("admin_user_id")
  createdAt     DateTime                @default(now()) @map("created_at")

  @@index([scrivenerId])
  @@index([createdAt])
  @@map("scrivener_audit_logs")
}


// --- 既存 enum ---

enum LinkType {
  GUIDE
  PDF
  E_APPLY
  REGULATION
  OTHER
}

model ImportLog {
  id           String    @id @default(uuid())
  adminUserId  String    @map("admin_user_id")
  filename     String
  fileType     String?   @map("file_type")
  totalCount   Int       @map("total_count")
  successCount Int       @map("success_count")
  failedCount  Int       @map("failed_count")
  errorLog     String?   @map("error_log")
  createdAt    DateTime  @default(now()) @map("created_at")
  adminUser    AdminUser @relation(fields: [adminUserId], references: [id])

  @@map("import_logs")
}

model Inquiry {
  id                  String                      @id @default(uuid())
  inquiryType         InquiryType                 @default(OHaka) @map("inquiry_type")
  status              InquiryStatus               @default(NEW)
  lastName            String                      @map("last_name")
  firstName           String                      @map("first_name")
  lastNameKana        String?                     @map("last_name_kana")
  firstNameKana       String?                     @map("first_name_kana")
  email               String
  phone               String
  postalCode          String?                     @map("postal_code")
  prefecture          String?
  city                String?
  addressDetail       String?                     @map("address_detail")
  cemeteryType        CemeteryType?               @map("cemetery_type")
  considerationPeriod ConsiderationPeriod?         @map("consideration_period")
  content             String
  destinationType     DestinationType?             @map("destination_type")
  boneServiceType     BoneServiceType?             @map("bone_service_type")
  containerType       ContainerType?               @map("container_type")
  ritanConsultation   Boolean?                     @map("ritan_consultation")
  preferredContact    String?                      @map("preferred_contact")
  memo                String?
  ipAddress           String?                      @map("ip_address")
  userAgent           String?                      @map("user_agent")
  scrivenerId         String?                      @map("scrivener_id")
  scrivener           AdministrativeScrivener?     @relation(fields: [scrivenerId], references: [id], onDelete: SetNull)
  createdAt           DateTime                     @default(now()) @map("created_at")
  updatedAt           DateTime                     @updatedAt @map("updated_at")

  @@index([inquiryType, status, createdAt])
  @@index([scrivenerId])
  @@map("inquiries")
}

model AuditLog {
  id             BigInt       @id @default(autoincrement())
  municipalityId String       @map("municipality_id")
  targetUrl      String       @map("target_url")
  httpStatus     Int?         @map("http_status")
  result         AuditResult  @map("result")
  errorMessage   String?      @map("error_message")
  checkedAt      DateTime     @default(now()) @map("checked_at")
  municipality   Municipality @relation(fields: [municipalityId], references: [id])

  @@index([municipalityId])
  @@map("audit_logs")
}

model LinkCheckRun {
  id           String         @id @default(cuid())
  startedAt    DateTime       @default(now()) @map("started_at")
  finishedAt   DateTime?      @map("finished_at")
  status       LinkCheckStatus @default(RUNNING)
  totalChecked Int            @default(0) @map("total_checked")
  brokenCount  Int            @default(0) @map("broken_count")
  fixedCount   Int            @default(0) @map("fixed_count")
  notes        String?

  @@map("link_check_runs")
}

model RecoveryCandidate {
  id           String                 @id @default(cuid())
  createdAt    DateTime               @default(now()) @map("created_at")
  jisCode      String                 @map("jis_code")
  prefecture   String
  municipality String
  prevUrl      String?                @map("prev_url")
  prevPdfUrl   String?                @map("prev_pdf_url")
  newUrl       String?                @map("new_url")
  newPdfUrl    String?                @map("new_pdf_url")
  confidence   Int                    @default(0)
  source       String
  status       RecoveryCandidateStatus @default(PENDING)
  runId        String?                @map("run_id")

  @@index([jisCode])
  @@index([status])
  @@index([runId])
  @@map("recovery_candidates")
}

enum Role {
  ADMIN
  OPERATOR
}

enum LinkStatus {
  OK
  PDF_ONLY
  NEEDS_REVIEW
  BROKEN
  UNKNOWN
}

enum LinkCheckStatus {
  RUNNING
  SUCCEEDED
  FAILED
}

enum RecoveryCandidateStatus {
  PENDING
  APPLIED
  REJECTED
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  DONE
  ARCHIVED
}

enum CemeteryType {
  TEMPLE
  PUBLIC
  PRIVATE
  COMMUNITY
  OTHER
  UNKNOWN
}

enum ConsiderationPeriod {
  IMMEDIATE
  WITHIN_HALF_YEAR
  WITHIN_YEAR
  UNDECIDED
}

enum DestinationType {
  NEW_GRAVE
  NOUKOTSUDO
  TREE_BURIAL
  SCATTERING
  HOME
  OTHER
}

enum BoneServiceType {
  POWDER
  WASH
  BOTH
  NONE
}

enum ContainerType {
  SEALED_BAG
  URN
  ORIGINAL_BOX
  BONE_BAG
  UNDECIDED
}

enum AuditResult {
  OK
  REDIRECT
  CLIENT_ERROR
  SERVER_ERROR
  TIMEOUT
  DNS_ERROR
  UNKNOWN_ERROR
}
