# Doc-05 Test Design v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、seiren-ohakajimai-navi の品質を継続的に担保するためのテスト方針、対象範囲、テストレベル、合否基準、CI 統合、運用手順を定義する。
本プロジェクトはエンタープライズ品質を要求し、差分最小変更原則と不変条件チェックを中核に据える。

---

## 2. 前提と制約

### 2.1 開発運用の制約

- force push 禁止
- 大量 git add 禁止。必ずファイル指定 add
- push は原則禁止。ローカルでコミットまで

### 2.2 技術前提

- Node v22 固定
- Server Component 中心
- SEO 強化を前提とし、sitemap と robots の整合性を品質対象に含める
- 監査ログは永続化され、テストで破壊的変更を起こさない

### 2.3 データ不変条件

- 自治体データは 1,737 件整合性を前提とする
- PDF 直リンクは url に入れない
- pdfUrl に格納する
- PDF_ONLY の場合
    - url は null
    - pdfUrl は PDF リンク
    - linkStatus は PDF_ONLY
    - linkType は PDF
- 不要な notes は残さない
- 非破壊スキーマ進化。破壊的変更は禁止

### 2.4 既存品質基盤

- verify:ci 導入済み
- 不変条件チェック導入済み

---

## 3. 品質目標

### 3.1 重大障害の予防

- リンク種別の誤格納をゼロにする
- 自治体データの件数ズレをゼロにする
- PDF_ONLY ルール逸脱をゼロにする

### 3.2 継続的なリグレッション防止

- 差分最小変更原則により、変更範囲外の挙動が変わらないことを自動で検知する

### 3.3 デプロイ前提の品質

- CI が通らない変更はマージ不可
- ローカルで verify:ci を通してからコミットする

---

## 4. テスト戦略

### 4.1 テストピラミッド

- **Unit**: 純粋関数、フォーマッタ、バリデーション、変換ロジック
- **Integration**: データ読み込みと不変条件チェック、ページ生成に必要なデータ結合
- **E2E**: ユーザ導線上の主要ページが正常表示され、必要なメタ情報が生成されること

### 4.2 重点領域

- データ不変条件
- 大量データ表示におけるパフォーマンス退行
- SEO 出力の整合性
- 監査ログの永続化と追跡可能性

### 4.3 対象外

- 外部サービスの障害やネットワーク品質による挙動は、モックまたはスタブで分離し本テスト範囲外とする

---

## 5. テストレベル設計

### 5.1 Unit テスト

**対象**

- データ正規化ロジック
- リンク種別振り分けロジック
- PDF_ONLY 判定ロジック
- slug 正規化ロジック
- 監査ログの整形ロジック

**必須観点**

- 入力の境界値
- null と空文字の取り扱い
- 既存データに対する非破壊性

**成果物**

- ユニットテストコード
- カバレッジは数値目標を固定しないが、重点領域のロジックはテスト必須

### 5.2 Integration テスト

**対象**

- データソースを読み込み、アプリが期待する構造に変換できること
- 1,737 件を読み込んだ際に不変条件が全件で成立すること
- verify:ci に統合し、ローカルと CI で同一結果になること

**必須観点**

- 件数検証
- 必須キーの存在検証
- PDF_ONLY ルールの全件検証
- url と pdfUrl の相互排他検証
- notes の不要残存検知

**成果物**

- 検証スクリプト
- CI 実行ログ

### 5.3 E2E テスト

**対象ページ**

- トップ
- 自治体一覧または検索導線の起点
- 改葬許可申請関連の主要表示ページ
- PDF 表示導線を含むページ

**必須観点**

- SSR での例外が発生しないこと
- 主要ページのタイトルとメタ情報が生成されること
- リンクが壊れていないこと
- 大量 DOM を誘発する箇所でフリーズが再発しないこと

**成果物**

- E2E シナリオ
- スクリーンショットなどの成果物は CI で保存可能な形を推奨

---

## 6. 不変条件チェック仕様

### 6.1 PDF_ONLY ルール

**対象**: 全自治体レコード

**検証**

- linkStatus が PDF_ONLY の場合
    - url が null
    - pdfUrl が非 null かつ空でない
    - linkType が PDF

### 6.2 PDF 直リンク誤格納防止

**検証**

- url に PDF 拡張子または PDF を示すパターンが入っていないこと
- 入っていた場合は失敗

### 6.3 件数検証

**検証**

- 自治体レコードの総数が 1,737 であること
- 差分適用や生成物更新で件数が増減した場合は失敗

### 6.4 notes 残存検知

**検証**

- 不要な notes を出力データに残さない
- 許容する notes の用途がある場合は Doc-03 に合わせて定義し、本項をバージョン更新する

---

## 7. CI 統合

### 7.1 verify:ci の役割

- 型チェック
- lint
- テスト
- 不変条件チェック
- ビルド検証

### 7.2 CI 合否基準

- verify:ci が成功すること
- 不変条件チェックが全件成功すること
- E2E の主要シナリオが成功すること

---

## 8. テストデータ方針

- 本番相当の自治体データを基準データとして扱う
- サンプル抽出は許可するが、全件検証を必須にする
- 生成物や派生データは上書き禁止の方針に従い、差分最小で更新する

---

## 9. リリース判定

### 9.1 変更分類

| 分類 | 内容 |
|------|------|
| A | 不変条件に関わる変更 |
| B | 表示と SEO に関わる変更 |
| C | リファクタリングのみ |

### 9.2 必須ゲート

| 分類 | 必須テストレベル |
|------|---------------|
| A | Unit, Integration, E2E の全通過 |
| B | Integration と E2E の通過 |
| C | Unit と Integration の通過 |

---

## 10. 運用手順

### 10.1 ローカル実行手順

- Node v22 を使用する
- verify:ci を実行する
- 失敗時は、最初に不変条件チェックの失敗を疑う

### 10.2 変更時の手順

- 差分は最小単位で適用する
- 設計変更が入る場合は対応する Doc をバージョン付与で追加する
- テスト設計変更も同様に v を上げる

---

## 11. 既知のリスクと対策

### 11.1 大量 DOM 退行

**対策**

- E2E で対象ページの表示完了を検証する
- パフォーマンス設計書で測定指標を追加する

### 11.2 PDF リンク誤格納

**対策**

- 不変条件チェックで確実に検知し CI を落とす
- 振り分けロジックは Unit と Integration の双方で固定する

---

## 12. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
