# Doc-16 Integrated Audit & Implementation Readiness v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、Doc-01〜Doc-15 の整合性を横断的に監査し、実装移行の合否基準を確定する。
Antigravity は本ドキュメントを実装開始ゲートとして扱い、未合格のまま実装へ進まない。

---

## 2. 適用範囲

- 設計資産の完全性監査
- 不変条件の整合監査
- データ統制と非破壊進化の監査
- SEOと性能の両立監査
- 監視と運用の実装準備監査
- API公開設計の実装準備監査

---

## 3. 参照ドキュメント

| Doc ID | タイトル |
|--------|---------|
| Doc-01 | Requirements Definition |
| Doc-02 | System Basic Design |
| Doc-03 | Database Detail Design |
| Doc-04 | Application Detail Design |
| Doc-05 | Test Design |
| Doc-06 | Security Design |
| Doc-07 | Performance Design |
| Doc-08 | Operations Runbook |
| Doc-09 | SEO Architecture Design |
| Doc-10 | Monitoring Observability Design |
| Doc-11 | Data Governance Integrity Design |
| Doc-12 | Scalability Evolution Design |
| Doc-13 | Risk Management Failure Mode Design |
| Doc-14 | Backup Disaster Recovery Design |
| Doc-15 | API Public Exposure Design |

---

## 4. 実装移行の絶対条件

以下は一つでも未達の場合、実装移行は禁止。

- Node v22 固定が破れていない
- 1,737自治体整合性が成立している
- PDF_ONLY 不変条件が全件で成立している
- 非破壊スキーマ進化方針が設計と運用に反映されている
- verify:ci がローカルで成功する
- docs の上書き禁止とバージョニングが守られている
- force push 禁止とファイル指定 add が運用ルールとして徹底されている

---

## 5. 不変条件監査項目

### 5.1 自治体件数

- データ総数が 1,737 である
- 差分適用で件数が増減していない
- 増減がある場合、即停止し原因特定後にのみ再開

### 5.2 PDF_ONLY ルール

linkStatus が PDF_ONLY の場合、必ず以下を満たす：

- url は null
- pdfUrl は null ではなく空でもない
- linkType は PDF

### 5.3 PDF直リンク誤格納禁止

- url に PDF を示す拡張子やパターンが入っていない
- PDF は pdfUrl にのみ存在する

### 5.4 notes 不要残存禁止

- 不要な notes が残っていない
- notes を許容する場合は用途と定義を Doc-03 と Doc-11 に明記し、監査条件も更新する

### 5.5 slug 整合

- municipalitySlug は一意
- 空や不正文字列が存在しない
- 揺れを補正するルールが Doc-03, Doc-11 と一致している

---

## 6. 設計整合監査項目

### 6.1 要件と設計の整合

- Doc-01 の要件が Doc-02, Doc-04 に落ちている
- 重要要件がテスト可能な形で Doc-05 に反映されている
- 重要要件が運用可能な形で Doc-08 に反映されている

### 6.2 セキュリティと運用の整合

- Doc-06 の禁止事項が Doc-08 の運用手順に含まれている
- 認証と権限制御の方針が将来 API 公開設計 Doc-15 と矛盾しない
- ログ削除禁止と監査可能性が Doc-10 と Doc-14 に反映されている

### 6.3 性能とSEOの整合

- Doc-07 の大量DOMリスク対策が UI 設計に反映されている
- Doc-09 の sitemap と robots 方針がビルドと運用に反映されている
- 生成物の肥大化が性能退行に繋がる場合のゲートが Doc-07 と Doc-05 に存在する

### 6.4 監視と障害対応の整合

- Doc-10 の監視項目が Doc-13 の故障モード検知と一致する
- Doc-14 の復旧手順が Doc-08 の運用フローと一致する
- 重大異常時に「どの情報を見るか」が Doc-10, Doc-08 に定義されている

### 6.5 データ統制と進化の整合

- Doc-11 の変更フローが Doc-08 の運用手順に一致する
- Doc-12 の進化ルールが Doc-03 の非破壊方針と一致する
- 破壊的変更は必ずバージョンアップで分離する方針が一貫している

### 6.6 API公開設計の整合

- Doc-15 の /api/v1 方針は破壊的変更を含まない
- 認証必須、レート制限、監査ログの必須条件が Doc-06, Doc-10 と一致する
- 公開データ範囲が個人情報を含まない前提と矛盾しない

---

## 7. 実装準備チェックリスト

### 7.1 実装前に確定すべきもの

- [ ] 対象ページとルート一覧
- [ ] データ入出力の形式と必須キー
- [ ] 不変条件チェックの実行方法と失敗時対応
- [ ] 監査ログの最低限のスキーマと保存先
- [ ] sitemap と robots の生成方法
- [ ] API を作る場合の OpenAPI 生成方法

### 7.2 実装で禁止されるパターン

- データを上書きして履歴を消す変更
- 既存スキーマの破壊的変更
- PDF を url に入れる仕様
- 全件一括レンダリングでフリーズを誘発するUI
- 例外を握り潰して静かに失敗する実装
- CI を通さない状態での実装進行

---

## 8. ゲート定義

### Gate 0: 設計資産の存在

- Doc-01〜Doc-15 が所定パスに存在する
- ファイル名が Doc-XX_ 形式で揃っている
- 上書きが発生していない

### Gate 1: データ整合

- 件数 1,737 が成立
- PDF_ONLY 全件成立
- slug 一意が成立

### Gate 2: CI整合

- verify:ci 成功
- 不変条件チェック成功
- ビルド成功

### Gate 3: 実装移行

- Gate 0〜2 全て成功
- 実装タスク分解が完了
- 変更管理ルールが実装手順に組み込まれている

---

## 9. 実行手順

### 9.1 ローカル前提確認

- 作業ディレクトリが固定パスであること
- Node v22 であること

### 9.2 監査実行

- verify:ci を実行し成功を確認
- 不変条件チェックログを確認
- sitemap と robots の生成物を確認

### 9.3 失敗時

- 最初に不変条件違反を疑う
- 次に件数ズレを疑う
- 次に直近変更ファイルを限定して原因特定する
- 推測で修正しない

---

## 10. 成果物

本監査で残すべき成果物：

- Gate 0〜3 の結果
- 失敗時の原因と修正差分
- 次に実装すべき最小タスクの一覧

---

## 11. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
