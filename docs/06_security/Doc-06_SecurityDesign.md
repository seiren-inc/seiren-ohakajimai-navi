# Doc-06 Security Design v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、本プロジェクトの情報資産を保護し、
改ざん・漏洩・誤更新・破壊的変更を防止するための
セキュリティ設計方針および実装レベル基準を定義する。

本設計はエンタープライズ品質を前提とする。

---

## 2. 保護対象資産

### 2.1 データ資産

- 自治体データ 1,737件
- 改葬許可関連データ
- 管理画面操作ログ
- 監査ログ
- 差分適用履歴

### 2.2 システム資産

- GitHub リポジトリ
- docs 設計資産
- CI 設定
- ビルド成果物

### 2.3 運用資産

- SSH 鍵
- Git remote 設定
- Node 実行環境

---

## 3. セキュリティ原則

### 3.1 最小権限原則

- 管理操作は必要最小限の範囲に限定
- 書き込み可能箇所は限定

### 3.2 非破壊原則

- スキーマは非破壊進化のみ
- データ削除は禁止
- 上書き禁止、必ずバージョン付与

### 3.3 監査可能性

- 変更は必ずログに残る
- 差分は追跡可能

### 3.4 不変条件優先

- PDF_ONLYルール等の整合性をセキュリティレベルで強制する

---

## 4. 脅威モデル

### 4.1 内部誤操作

- 誤った git add -A
- force push
- 誤ったデータ上書き

**対策**

- force push 禁止
- ファイル指定 add 強制
- verify:ci 通過必須

### 4.2 データ改ざん

- PDFリンク誤格納
- 件数改変
- 不正slug生成

**対策**

- 不変条件チェック
- CI失敗によるマージ阻止

### 4.3 不正アクセス

- 管理画面の未認証アクセス
- サーバー側APIの直接叩き

**対策**

- Server Component中心設計
- APIは内部利用前提
- 管理操作の認証必須

### 4.4 ビルド環境リスク

- Nodeバージョン差異
- パッケージ汚染

**対策**

- Node v22固定
- lockファイル厳守
- CI環境固定

---

## 5. 認証・認可設計

### 5.1 管理機能

- 明示的な認証層を通す
- 未認証状態でのデータ更新不可

### 5.2 権限制御

- 読み取りと書き込みを分離
- データ更新操作は限定エンドポイントのみ

---

## 6. データ整合性防御

### 6.1 PDF_ONLY強制

以下条件が成立しない場合は処理失敗：

- url=null
- pdfUrl非null
- linkStatus=PDF_ONLY
- linkType=PDF

### 6.2 件数検証

- 自治体件数が1,737以外の場合は失敗

### 6.3 非破壊スキーマ

- DROP禁止
- カラム削除禁止
- ALTERは追加のみ

---

## 7. ログ設計

### 7.1 監査ログ

- 誰が
- いつ
- 何を変更したか
- 変更前後差分

### 7.2 永続化

- ログは削除禁止
- 上書き不可

---

## 8. Gitセキュリティ運用

### 8.1 禁止事項

- force push
- 大量add
- main直コミット

### 8.2 必須手順

- git status確認
- ファイル指定add
- commit message明確化
- pushは原則禁止

---

## 9. CIセキュリティゲート

verify:ci は以下を保証：

- 型安全
- 不変条件整合
- ビルド成功
- テスト成功

いずれか失敗時はマージ不可

---

## 10. SEO関連の安全性

### 10.1 robots.txt

- 機密情報へのクロール禁止

### 10.2 sitemap

- 存在しないURLを含めない

---

## 11. 将来拡張への安全設計

- API公開時はトークンベース認証
- レート制限設計
- 入力値バリデーション強化

---

## 12. インシデント対応

### 12.1 データ破損検知時

- 直近コミット確認
- 差分復元
- バージョン戻し

### 12.2 CI失敗時

- 不変条件ログ確認
- 件数差分確認
- 直近変更ファイル限定修正

---

## 13. リリース基準

以下全て満たすこと：

- verify:ci 成功
- 不変条件成功
- 重大セキュリティ警告ゼロ

---

## 14. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
