# Doc-07 Performance Design v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、seiren-ohakajimai-navi のパフォーマンス品質を継続的に担保するため、
性能要件、ボトルネックの想定、設計原則、計測指標、退行防止ゲート、運用手順を定義する。

対象は以下に限定する。

- 1,737自治体データを前提としたページ表示とデータ処理
- Server Component 中心の描画
- SEO 出力を含むビルドおよび配信経路

---

## 2. 前提

- Node v22 固定
- Server Component 中心
- 差分最小変更原則
- verify:ci 導入済み
- 1,737自治体整合性前提
- PDF_ONLY 等の不変条件チェックが存在

---

## 3. 性能目標

### 3.1 ユーザー体感の目標

- 初回表示でのフリーズ、無限ローディングをゼロにする
- スクロールやアコーディオン操作での操作不能をゼロにする

### 3.2 ビルドと配信の目標

- CI とローカルでのビルド時間が急増した場合に検知できる
- ルート追加やSEO生成物増加による退行を検知できる

---

## 4. 主な性能リスク

### 4.1 大量DOM生成

- 1,737件を一括レンダリングする構造はブラウザがフリーズしやすい。

### 4.2 データ結合コスト

- 自治体データとリンク情報、PDF情報などの結合が O(n^2) 的になると退行する。

### 4.3 ルートとSEO生成物の肥大化

- sitemap 生成や静的生成が過剰になるとビルドが不安定になる。

### 4.4 Nodeバージョン差異

- Node v22 以外ではサイレントフリーズなどの再発リスクがある。

---

## 5. 設計原則

### 5.1 遅延レンダリング

一覧系は段階表示を前提とする。

- 折りたたみ
- ページネーション
- 仮想化または分割描画
- クリティカル領域のみ先にレンダリング

### 5.2 計算量の制御

- 1回のレンダリングで全件を走査しない
- 事前に map 化し O(1) 参照に寄せる
- ソートやフィルタは必要時のみ実行する

### 5.3 キャッシュ方針の明確化

- 変化しないデータはビルド時またはサーバー側で再利用可能にする
- 変化しうるデータはキャッシュ無効化も含め方針を固定する
- 本項は既存 Doc-02, Doc-04 の方針に従い、差異があればバージョン更新する

### 5.4 例外とフォールバック

- データ欠損やリンク欠損でページ全体が落ちない
- 不変条件違反は CI で止める
- 実行時はユーザーに安全な表示で退避する

---

## 6. 計測指標

### 6.1 フロント体感

- ページ初回描画完了までの時間
- 操作可能になるまでの時間
- 長タスクの発生有無

### 6.2 サーバー側

- 主要ページのレンダリング時間
- データ結合処理の所要時間

### 6.3 ビルド

- build 所要時間
- sitemap 生成所要時間
- 生成物ファイル数の増減

### 6.4 安定性

- ランタイム例外の発生件数
- CI 失敗率

---

## 7. 退行防止ゲート

### 7.1 verify:ci ゲート

- 型チェック成功
- テスト成功
- 不変条件成功
- ビルド成功

### 7.2 性能ゲート

以下のいずれかを満たす場合は退行として扱い、原因究明を必須とする。

- build 時間が前回基準から大幅に増加
- 生成物ファイル数が不自然に増加
- E2E の主要ページ表示完了がタイムアウト

数値閾値は本プロジェクトの現状計測値を取得した後に v1.1 で確定する。
推測で固定しない。

---

## 8. 性能テスト設計

### 8.1 スモーク性能テスト

- 主要ページを開いて描画完了を確認
- 一覧ページで折りたたみを開閉し、フリーズしないことを確認
- PDF 表示導線の遷移が正常であることを確認

### 8.2 回帰テスト

- 1,737件を読み込んだ状態で主要シナリオが通ること
- 以前に問題になった大量DOM箇所で退行しないこと

---

## 9. 実装上の推奨

- 一覧は分割描画を最優先
- データ結合は index 化してから参照する
- 文字列操作やslug生成は事前計算に寄せる
- 計測はログとCIで追跡可能な形で残す

---

## 10. 運用手順

### 10.1 変更前

- 変更対象ページと影響範囲を明示
- verify:ci を実行
- 主要ページの手動スモーク

### 10.2 変更後

- verify:ci を再実行
- ビルド時間の変化を確認
- 大量DOM対象ページの体感確認

---

## 11. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
