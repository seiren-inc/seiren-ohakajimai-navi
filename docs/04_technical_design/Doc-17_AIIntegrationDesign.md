# Doc-17 AI Integration Architecture v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、本サイトにおけるAI導入の設計を定義する。
狙いは以下の両立。

- 正確性の最大化
- 運用効率の最大化
- SEOとユーザー導線の強化

本プロジェクトの性質上、AIは事実生成や法解釈を担わない。
AIはデータ整合監査、検索誘導、要約支援に限定し、根拠は必ずDBおよび出典リンクに依存する。

---

## 2. 適用範囲と非適用範囲

### 2.1 適用範囲

**内部向けAI**

- データ監査AI
- リンク監査AI
- 差分レポートAI
- SEO文案の下書きAI

**公開向けAI**

- RAG型ナビゲーションAI
- ユーザー入力を分類し、該当ページ誘導とDB事実の引用のみを行う

### 2.2 非適用範囲

- 法解釈の生成
- 自治体の公式見解の推測
- DBに存在しない事実の断定
- 行政手続きの保証表現
- 医療、法律、税務などの個別判断

---

## 3. AI導入の基本原則

### 3.1 根拠必須

公開出力は必ず根拠を持つ。
根拠とは、DBのフィールド値と公式PDFまたは公式ページへのリンク。

### 3.2 非生成優先

回答生成より、誘導と引用を優先する。
説明文が必要な場合はテンプレート文とDB差し込みで構成し、生成AIは下書き用途に留める。

### 3.3 失敗時は安全に倒す

根拠が揃わない場合は回答しない。
該当ページの案内、または問い合わせ導線へ誘導する。

### 3.4 監査ログ永続化

AIの出力、参照根拠、判断理由、ユーザー入力を監査ログに保存する。
ログ削除は禁止。

---

## 4. ユースケース設計

### 4.1 内部: データ監査AI

**目的**

PDF_ONLYルール違反、件数ズレ、slug揺れ、urlとpdfUrlの混在を検知し、修正候補を提示する。

**入力**

- 自治体レコード全件
- リンクフィールド
- slugマップ
- 不変条件ルール

**出力**

- 違反一覧
- 修正提案
- 影響範囲
- リグレッション注意点

**合否**

- 不変条件違反の検知率100%を目標
- 誤検知は許容するが見逃しは不可

### 4.2 内部: リンク監査AI

**目的**

リンク切れ、PDFリンクの非到達、公式ページのリダイレクト変化を検知し、更新候補を提示する。

**入力**

- url, pdfUrl 一覧

**出力**

- 到達可否
- HTTPステータス
- 更新候補
- 再検査推奨頻度

**注意**

外部アクセス実施は運用ポリシーと整合する範囲で行う。

### 4.3 内部: 差分レポートAI

**目的**

データ差分を人が理解できる形に要約する。
上書き禁止ポリシーに従い、差分の説明を生成し、コミット説明の品質を上げる。

**入力**

- 変更前後のJSON差分
- 該当自治体識別子

**出力**

- 何が変わったか
- なぜ必要か
- リスク
- 検証ポイント

### 4.4 内部: SEO文案下書きAI

**目的**

titleやdescriptionの下書きを作るが、公開前に必ず人がレビューし、重複検知を通す。

**入力**

- 自治体名、都道府県、ページ種別、主要キーワード

**出力**

- 下書き候補
- 重複リスク指摘
- 内部リンク候補

**制約**

断定表現を禁止し、案内調で統一する。

### 4.5 公開: RAG型ナビゲーションAI

**目的**

ユーザーの質問を分類し、適切なページへ誘導する。
DB事実の引用が可能な場合のみ、短く提示する。

**想定質問**

- 改葬許可申請のやり方
- 必要書類
- 自治体ごとの申請先
- PDFの場所
- 問い合わせ先の確認

**必須要件**

ユーザーに返す内容は以下のいずれか。

- 該当ページURLの提示
- DBの事実フィールドを引用して提示
- 公式PDFリンクの提示

**禁止**

- 手続きの保証
- 法解釈
- 未確認情報の補完
- 自治体ごとの差分を推測で埋める

---

## 5. RAG設計詳細

### 5.1 ナレッジソース

| 優先度 | ソース | 備考 |
|--------|--------|------|
| 第一優先 | DBの正規化済みフィールド | |
| 第二優先 | 公式PDFおよび公式ページのリンク | リンクそのものを提示し、内容の断定はしない |
| 第三優先 | サイト内ガイド記事 | ガイドは出典リンクを持つことが必須 |

### 5.2 Retrieval単位

- 自治体単位
- ページ種別単位
- ガイド章単位

### 5.3 出力フォーマット

短文固定。根拠を必ず併記。根拠がない場合は回答拒否して誘導。

例：

```
回答:
該当自治体の改葬許可申請ページはこちらです。[URL]

根拠:
DB municipalitySlug と guidePage の参照
公式PDFがある場合は pdfUrl を併記
```

### 5.4 ランキング

- 最優先で自治体一致
- 次に都道府県一致
- 次に一般ガイド
- スコアは透明化し、監査ログに保存

---

## 6. セキュリティ設計

### 6.1 入力保護

- ユーザー入力は検疫する
- プロンプトインジェクション対策として、システム指示の上書きを拒否する

### 6.2 出力保護

- 個人情報を返さない
- 管理用情報を返さない
- 内部IDや管理URLは返さない

### 6.3 認証と権限

- 内部AIは管理者のみ利用可能
- 公開RAGは読み取り専用
- 書き込み系のAI操作は存在させない

---

## 7. 監査ログ設計

保存項目：

- 日時
- ユーザー種別（公開か内部か）
- 入力テキスト
- 参照したデータキー一覧
- 参照したURL一覧
- 出力テキスト
- 安全判定（参照不足で拒否したか）
- レイテンシ

削除禁止。改ざん検知可能な形で保存。

---

## 8. 品質ゲート

### 8.1 事実性ゲート

- 公開出力は必ず参照キーを持つ
- 参照キーなしは即ブロック

### 8.2 不変条件ゲート

- PDF_ONLYルールや件数整合が壊れている状態では公開AIを停止する
- 停止中はガイド固定ページへの誘導のみを返す

### 8.3 テストゲート

Doc-05のテスト設計にAIテストを追加する。最低限：

- 根拠なし回答が出ない
- 危険表現が出ない
- 同一質問での結果が安定している

---

## 9. パフォーマンスとコスト

公開AIはリクエスト数が増える可能性があるため、以下を必須とする。

- レート制限
- キャッシュ
- 短い応答
- 高コスト処理の禁止

---

## 10. フェイルセーフ設計

**故障時の挙動**

- AI機能停止
- サイト閲覧と検索は継続
- 問い合わせ導線は常時提示

**根拠不足時の挙動**

- 回答拒否
- 該当ページ候補の提示
- ユーザーに自治体名入力を促す

---

## 11. 実装タスク分解の前提

この設計を実装へ落とす際は、以下を最小単位で分割する。

- 内部AI監査（バッチ）
- RAGナビ（API）
- 参照用のデータ整備
- 監査ログ保存
- ガードレール（テスト）

---

## 12. リリース段階

| Phase | 内容 |
|-------|------|
| Phase 1 | 内部: データ監査AIのみ |
| Phase 2 | 内部: リンク監査と差分レポート |
| Phase 3 | 公開: RAG型ナビゲーション（根拠付き誘導のみ） |

公開チャット型の自由回答は採用しない。

---

## 13. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
