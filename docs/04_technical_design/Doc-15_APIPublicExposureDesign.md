# Doc-15 API Public Exposure Design v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、
seiren-ohakajimai-navi の将来的 API 公開に備え、
安全性・整合性・スケーラビリティを担保した
公開 API 設計を定義する。

本設計は以下を前提とする。

- 既存 1,737自治体データを破壊しない
- 非破壊スキーマ進化
- PDF_ONLY 不変条件厳守
- CIゲート強制
- 監査ログ永続化
- Server Component中心設計

API公開は既存アーキテクチャを壊さない拡張とする。

---

## 2. API公開方針

### 2.1 公開レベル分類

| Level | 説明 |
|-------|------|
| Level 0 | 内部利用専用 API（非公開） |
| Level 1 | 認証必須 API（B2B想定） |
| Level 2 | 公開読み取り API（制限付き） |

本設計では Level 1 を標準とする。

---

## 3. エンドポイント設計原則

### 3.1 ベースパス

```
/api/v1/
```

将来の破壊的変更は v2 で対応。
v1 は非破壊進化のみ。

### 3.2 REST原則

| Method | 用途 |
|--------|------|
| GET | 読み取り専用 |
| POST | 作成 |
| PUT | 更新 |
| DELETE | 原則禁止（論理削除のみ許可） |

---

## 4. 想定公開エンドポイント

### 4.1 自治体一覧取得

```
GET /api/v1/municipalities
```

レスポンス制約：

- slug
- 自治体名
- 都道府県
- 改葬許可有無
- PDF_ONLY状態

件数はページネーション必須。
全件一括返却禁止。

### 4.2 自治体詳細取得

```
GET /api/v1/municipalities/{slug}
```

必須整合：

- slug唯一
- PDF_ONLY整合
- url/pdfUrl排他

### 4.3 改葬情報取得

```
GET /api/v1/municipalities/{slug}/guide
```

### 4.4 将来拡張予約

```
POST /api/v1/inquiries
```

- 認証必須
- 入力バリデーション必須

---

## 5. 認証設計

### 5.1 認証方式

- Bearer Token方式
- 将来的にはJWT
- API Key方式も許容

### 5.2 必須事項

- 全POSTは認証必須
- Level 1 APIは認証必須
- トークン漏洩時即無効化可能設計

---

## 6. レート制限設計

### 6.1 制限原則

- IP単位制限
- トークン単位制限
- burst制御

### 6.2 デフォルト制限例

- 1分あたり上限
- 1日あたり上限

※具体数値はトラフィック観測後に確定

---

## 7. データ整合保証

APIレスポンスは以下を保証する。

- 1,737件整合
- PDF_ONLYルール遵守
- slug重複ゼロ
- null禁止フィールド明示

不変条件違反時は 500 を返さない。
ログ記録し 503 で保護。

---

## 8. バージョニング戦略

### 8.1 非破壊進化

- フィールド追加は許可
- 既存フィールド削除禁止
- 型変更禁止

### 8.2 破壊的変更

- /api/v2 で分離
- v1は最低1年間維持

---

## 9. セキュリティ設計連動

- CORS制御
- 入力値バリデーション
- SQLインジェクション防止
- XSS防止
- レスポンスサイズ制限

---

## 10. 監査ログ設計

API操作は必ず記録する。

記録項目：

- トークンID
- IP
- エンドポイント
- ステータスコード
- レスポンス時間

ログ削除禁止。

---

## 11. エラー設計

標準レスポンス形式：

```json
{
  "success": false,
  "errorCode": "STRING",
  "message": "簡潔な説明"
}
```

内部詳細は露出しない。

---

## 12. パフォーマンス設計連動

- ページネーション必須
- 全件取得禁止
- N+1クエリ禁止
- O(n^2)処理禁止

---

## 13. 可用性設計

| ステータス | 用途 |
|-----------|------|
| 503 | 一時的エラー |
| 429 | レート超過 |
| 401 | 認証失敗 |

---

## 14. データ保護

- 個人情報はAPI公開しない
- 問い合わせデータは非公開

---

## 15. 将来拡張

- Webhook対応
- 外部連携
- ダッシュボード連携

---

## 16. 実装必須チェックリスト

- [ ] /api/v1 形式
- [ ] 認証層存在
- [ ] レート制限実装
- [ ] 不変条件検証内蔵
- [ ] CIでAPIテスト追加
- [ ] OpenAPI定義作成

---

## 17. OpenAPI設計

- 必ず OpenAPI 仕様書を生成する
- 型は TypeScript と一致させる
- 手動管理禁止

---

## 18. リスク

| リスク | 対策 |
|--------|------|
| API乱用 | レート制限 |
| データスクレイピング | 認証 |
| slug列挙攻撃 | アクセスログ監視 |

---

## 19. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
