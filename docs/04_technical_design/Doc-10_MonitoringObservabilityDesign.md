# Doc-10 Monitoring & Observability Design v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、本プロジェクトにおける
異常検知・ログ収集・トレース・監視基準を定義し、
問題発生時に即時原因特定可能な状態を維持することを目的とする。

対象範囲：

- アプリケーションログ
- 不変条件監視
- ビルド監視
- SEO整合監視
- データ件数監視

---

## 2. 可観測性の原則

- ログは削除しない
- 変更は追跡可能
- エラーは握り潰さない
- 異常はCIで止める

---

## 3. ログ分類

### 3.1 アプリケーションログ

- ページレンダリング失敗
- データ結合失敗
- slug不一致

### 3.2 データ整合ログ

- 件数差分
- PDF_ONLY違反
- url/pdfUrl矛盾

### 3.3 CIログ

- 型エラー
- テスト失敗
- ビルド失敗

---

## 4. 監視対象

### 4.1 件数監視

- 自治体件数が 1,737 以外になった場合は異常

### 4.2 不変条件監視

- PDF_ONLY整合
- urlにPDF直リンク混入なし

### 4.3 ビルド監視

- build失敗
- build時間急増

### 4.4 SEO監視

- sitemap URL存在確認
- 重複URL検出
- title重複検出

---

## 5. エラーハンドリング設計

### 5.1 原則

- ユーザーに詳細エラーを露出しない
- 内部ログには完全記録

### 5.2 分類

**致命的エラー**

- レンダリング不能
- データ破損

**警告**

- 一部リンク欠損
- description欠落

---

## 6. アラート設計

### 6.1 CIレベル

- 失敗時はマージ不可

### 6.2 手動確認レベル

- build時間比較
- 大量DOM箇所の体感確認

---

## 7. トレース設計

### 7.1 変更追跡

- git logで追跡可能
- 変更ファイル限定修正

### 7.2 データ差分追跡

- 変更前後の件数比較
- 変更前後のslug一覧比較

---

## 8. 障害対応フロー

1. 異常検知
2. 直近コミット確認
3. 差分確認
4. 不変条件再実行
5. 必要ならロールバック

---

## 9. 可視化方針

- CIログを一次情報とする
- ローカルで再現可能であること
- 外部監視に依存しない設計

---

## 10. 将来拡張

- API公開時はアクセスログ監視追加
- レート制限検知追加
- 不正アクセスパターン検出

---

## 11. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
