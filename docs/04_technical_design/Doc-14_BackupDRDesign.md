# Doc-14 Backup & Disaster Recovery Design v1.0

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、本プロジェクトにおける
バックアップ戦略および災害復旧（Disaster Recovery, DR）設計を定義する。

目的は以下の通り。

- データ消失の防止
- 誤更新からの復旧
- インフラ障害からの迅速復旧
- 人的ミスからの完全回復
- 事業継続性の担保

本設計は「削除される前提」「壊れる前提」で設計する。

---

## 2. 保護対象資産

### 2.1 コード資産

- GitHub リポジトリ
- docs 設計書群
- CI 設定

### 2.2 データ資産

- 1,737自治体データ
- 改葬許可関連データ
- slugマッピング
- PDFリンク情報

### 2.3 生成物

- sitemap
- 静的生成ページ
- ビルド成果物

### 2.4 構成情報

- Nodeバージョン固定情報
- 環境変数
- SSH鍵（論理対象）

---

## 3. RPO / RTO 定義

### RPO（Recovery Point Objective）

最大許容データ損失時間

本プロジェクトでは **RPO = 1 commit**

理由：
全変更は git commit 単位で管理されるため、
最悪でも直近コミット以前へ戻せれば良い。

### RTO（Recovery Time Objective）

最大許容復旧時間

目標：**重大障害時 2時間以内に復旧可能**

---

## 4. バックアップ戦略

### 4.1 コードバックアップ

| 区分 | 保存先 |
|------|--------|
| Primary | GitHub（remote SSH） |
| Secondary | ローカル clone |

原則：

- force push 禁止
- main 直コミット禁止
- 全変更は commit 履歴保持

追加推奨：

- 定期的に mirror clone を別物理場所へ保存可能設計

### 4.2 docs バックアップ

- 設計書は必ずリポジトリ内保存
- セッション依存禁止
- 上書き禁止、バージョン付与

### 4.3 データバックアップ

データは git 管理下であることが前提。

重要：自治体データは commit 履歴そのものがバックアップ。

追加設計：

- 自治体件数一覧のスナップショット出力
- slug一覧の定期保存

---

## 5. バックアップ頻度

- 変更発生ごとに commit
- マージ前に verify:ci 実行
- 重大変更前はバックアップブランチ作成

---

## 6. 災害シナリオ定義

### 6.1 誤コミットによるデータ破壊

**症状**

- 件数減少
- slug崩壊
- PDF_ONLY違反

**対応**

1. git log で特定
2. 該当commit revert
3. 不変条件再実行
4. 再build確認

### 6.2 main ブランチ破壊

**症状**

- 誤force push
- 履歴消失

**対応**

1. remote履歴確認
2. reflog確認
3. バックアップcloneから復元

※force push禁止のため発生確率は極小

### 6.3 ローカル環境消失

**症状**

- Mac故障
- フォルダ削除

**対応**

1. GitHub clone
2. Node v22 再構築
3. npm install
4. verify:ci 実行

### 6.4 Nodeバージョン事故

**症状**

- ビルドフリーズ
- 挙動異常

**対応**

1. node -v 確認
2. v22へ戻す
3. lockファイル確認

### 6.5 CI破損

**症状**

- verify:ci が常に失敗

**対応**

1. 直近変更差分確認
2. ローカル再現
3. CI設定ロールバック

---

## 7. データ完全消失シナリオ

最悪ケース：

- リポジトリ削除
- ローカル削除

復旧方法：

- GitHub履歴から復元
- clone再取得
- 直近タグまたはcommitへ戻す

対策強化案：

- 定期的タグ付与
- 重要マイルストーンでタグ固定

---

## 8. バックアップ検証

バックアップは「存在する」だけでは意味がない。

定期確認項目：

- cloneできるか
- 過去commitへcheckoutできるか
- 1,737件整合するか
- verify:ci通るか

---

## 9. ディザスターレベル分類

| Level | 深刻度 | 例 |
|-------|--------|-----|
| Level 1 | 軽微 | ビルド失敗 |
| Level 2 | 中規模 | データ破損 |
| Level 3 | 重大 | 履歴消失、リポジトリ削除 |
| Level 4 | 致命的 | バックアップなし |

※Level 4 は設計上発生しない構造とする

---

## 10. ロールバック設計

原則：

- 変更を上書きしない
- revertを使う
- 履歴を壊さない

禁止：

- 履歴改ざん
- 強制push

---

## 11. 将来強化可能項目

- 自動スナップショット
- 定期アーカイブ
- 外部ストレージミラー
- 自動タグ運用

---

## 12. テスト復旧手順（推奨）

年1回は以下を実施：

1. 過去commitへ戻す
2. verify:ci 実行
3. 現行へ戻す
4. 差分確認

復旧訓練をしないDRは無意味。

---

## 13. 事業継続性

このプロジェクトは

- コード = 資産
- データ = 資産
- slug整合 = 生命線

よって以下を最優先とする：

- 削除禁止
- 履歴保存
- 非破壊進化

---

## 14. 変更履歴

| Version | 内容 |
|---------|------|
| v1.0 | 初版 |
