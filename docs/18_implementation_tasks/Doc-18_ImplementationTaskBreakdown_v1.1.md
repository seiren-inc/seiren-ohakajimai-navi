# Doc-18 Implementation Task Breakdown v1.1

Project: seiren-ohakajimai-navi

## 1. 目的

本ドキュメントは、Doc-01〜Doc-17 を実装へ落とすためのタスク分解、実装順序、完了条件、禁止事項、検証方法を固定する。
Antigravity は本ドキュメントを実装の実行計画として扱い、順序を崩さずに進める。

---

## 2. 前提

### 2.1 環境

- ローカル固定パス: `/takumashinnyo/workspace/projects/seiren-ohakajimai-navi`
- iCloud 不使用
- Node v22 固定

### 2.2 Git運用

- force push 禁止
- 大量 git add 禁止、必ずファイル指定 add
- 差分最小変更原則
- push 禁止、ローカルで commit まで

### 2.3 品質ゲート

- verify:ci 導入済み
- 不変条件チェック導入済み
- 1,737自治体整合性
- PDF_ONLY ルール厳守
- 非破壊スキーマ進化

### 2.4 AI導入の制約

- 公開AIは根拠必須、DB参照と公式リンク提示のみ
- 生成AIに事実生成、法解釈をさせない

---

## 3. 実装の全体順序

| Stage   | 内容                               |
| ------- | ---------------------------------- |
| Stage 0 | 実装準備と監査ゲート確立           |
| Stage 1 | データ層と不変条件の実装固定       |
| Stage 2 | ルーティングとページ生成の実装固定 |
| Stage 3 | SEO生成物の実装固定                |
| Stage 4 | 性能対策の実装固定                 |
| Stage 5 | 管理運用と監査ログの実装固定       |
| Stage 6 | 内部AI監査バッチの実装             |
| Stage 7 | 公開RAGナビの実装                  |
| Stage 8 | ハードニングと最終リリース判定     |

---

## 4. Stage 0: 実装準備と監査ゲート確立

### 4.1 タスク

- T0-01: docs存在確認とパス整合
- T0-02: Node v22 固定確認
- T0-03: verify:ci をローカルで実行し基準ログを保存
- T0-04: 不変条件チェックを単独実行できるコマンドとして固定
- T0-05: Gate 0〜2 の監査チェックリストを実行し、結果を記録

### 4.2 完了条件

- verify:ci が成功する
- 不変条件チェックが成功する
- 1,737件整合が成立する
- PDF_ONLY が全件成立する

### 4.3 禁止事項

- 基準が通っていない状態で機能実装に入ること

---

## 5. Stage 1: データ層と不変条件の実装固定

### 5.1 タスク

- T1-01: データ読み込みモジュールを単一責務で固定
- T1-02: 自治体データの正規化処理を固定
- T1-03: slug 正規化と一意性チェックを固定
- T1-04: PDF_ONLY ルール検証を固定
- T1-05: url に PDF 直リンク混入検知を固定
- T1-06: notes 不要残存検知を固定
- T1-07: 上記を verify:ci に統合し、失敗時にCIを落とす

### 5.2 完了条件

- 全検証が1回の実行で再現できる
- 検証失敗時に原因が特定可能なログを出す
- 1,737件と不変条件が常に守られる

### 5.3 禁止事項

- 検証を握り潰す
- 検証失敗を警告扱いにして通す

---

## 6. Stage 2: ルーティングとページ生成の実装固定

### 6.1 タスク

- T2-01: 公開ページのルート一覧を確定し docs に保存
- T2-02: 自治体ページの生成とデータ結合を固定
- T2-03: ガイドページの生成とデータ結合を固定
- T2-04: PDF_ONLY の場合の表示分岐を固定
- T2-05: エラー時のフォールバック表示を固定
- T2-06: E2E で主要ページの表示完了を検証する

### 6.2 完了条件

- 主要ルートが例外なく表示できる
- 欠損があっても落ちない
- E2E が安定して通る

### 6.3 禁止事項

- 全件一括レンダリングでブラウザフリーズを誘発する実装
- クライアント依存のメタ生成

---

## 7. Stage 3: SEO生成物の実装固定

### 7.1 タスク

- T3-01: title 生成規則の実装固定
- T3-02: description 生成規則の実装固定
- T3-03: canonical を自己参照で固定
- T3-04: robots.txt を設計どおり固定
- T3-05: sitemap 生成を設計どおり固定
- T3-06: sitemap 内URLの存在検証をCIゲート化
- T3-07: title と description の重複検知をCIゲート化

### 7.2 完了条件

- sitemap に無効URLが含まれない
- 重複が検知される
- 主要ページのメタがサーバーで確定する

### 7.3 禁止事項

- 存在しない自治体URLの生成
- PDFリンクを sitemap に含める
- 重複メタを放置

---

## 8. Stage 4: 性能対策の実装固定

### 8.1 タスク

- T4-01: 一覧ページの遅延レンダリング実装固定
- T4-02: 分割表示、折りたたみ、ページネーションのいずれかを採用し固定
- T4-03: データ結合を index 化し O(1) 参照に寄せる
- T4-04: build 所要時間と生成物数を記録し退行検知の基準を作る
- T4-05: 大量DOM対象ページのE2Eタイムアウト検知を追加

### 8.2 完了条件

- フリーズ再発がE2Eで検知できる
- 退行時に戻せる基準が残る

### 8.3 禁止事項

- ネストループでの全件結合
- 重い処理をレンダリング毎に繰り返す

---

## 9. Stage 5: 管理運用と監査ログの実装固定

### 9.1 タスク

- T5-01: 管理操作の認証必須化
- T5-02: 権限制御の境界を固定
- T5-03: 監査ログの保存スキーマを固定
- T5-04: 監査ログの永続化と削除禁止を実装で担保
- T5-05: インシデント時のログ参照導線を運用に固定

### 9.2 完了条件

- 誰が、いつ、何を変えたか追跡できる
- 監査ログが消えない

### 9.3 禁止事項

- 管理操作が未認証で可能
- ログの上書きや削除

---

## 10. Stage 6: 内部AI監査バッチの実装

### 10.1 目的

公開前にデータ不整合を検知し、修正候補を作る。
AIは事実生成をしない。検知と要約のみ。

### 10.2 タスク

- T6-01: AI監査バッチの実行コマンドを固定
- T6-02: 入力をDBまたは正規化済みデータに限定
- T6-03: 出力を違反一覧と修正候補に限定
- T6-04: 監査ログへ入力と出力を保存
- T6-05: 根拠として参照したキー一覧を保存
- T6-06: 誤検知は許容、見逃しを最小化する設計に寄せる
- T6-07: CIに組み込むかは運用負荷を見て段階導入する

### 10.3 完了条件

- PDF_ONLY違反や件数ズレの検知が安定する
- 出力が修正作業に直結する
- **公開RAG（Stage 7）を有効化する前に、内部AI監査バッチが最低30日間安定稼働し、重大違反ゼロであること**

**重大違反の定義（見逃しをゼロにする対象）：**

- PDF_ONLY違反の見逃し
- 件数不整合（1,737件以外）の見逃し
- slug重複の見逃し

内部監査が上記条件を満たさない限り、公開AIの有効化は禁止する。

### 10.4 禁止事項

- AIに新しい事実を生成させる
- AI出力を無検証でデータに反映する

---

## 11. Stage 7: 公開RAGナビの実装

### 11.1 目的

ユーザーの質問を分類し、該当ページへの誘導とDB事実の引用だけを返す。
根拠がない場合は回答しない。

### 11.2 タスク

- T7-01: 入力分類の設計を固定
- T7-02: Retrieval は自治体単位とページ単位で固定
- T7-03: 出力フォーマットを固定
- T7-04: 根拠キーと公式リンクを必須にするガードレールを実装
- T7-05: 根拠不足時のフォールバックを固定
- T7-06: レート制限を実装
- T7-07: 監査ログに入力、参照、出力、拒否理由を保存
- T7-08: 安全テストを追加（根拠なし回答が出ない、法解釈が出ない、個人情報が出ない）

### 11.3 完了条件

- 根拠なし回答がゼロ
- 常に誘導または引用で収まる
- ログで追跡できる

### 11.4 禁止事項

- 自由回答チャット
- 推測による自治体差分補完
- 保証表現

---

## 12. Stage 8: ハードニングと最終リリース判定

### 12.1 タスク

- T8-01: セキュリティ再監査
- T8-02: 性能退行チェック
- T8-03: SEO整合チェック
- T8-04: DR手順のテスト復旧訓練
- T8-05: 重大故障モードの机上訓練
- T8-06: リリースチェックリストを docs に保存

### 12.2 完了条件

- Gate 0〜3 を全て満たす
- 重大リスクに対する復旧手順が実行可能

---

## 13. タスク完了の共通定義

各タスクは以下を満たしたとき完了とする。

- 仕様が docs に保存されている
- 実装が差分最小である
- verify:ci が成功する
- 不変条件が成立する
- 失敗時のログが残る

---

## 14. 実装時の絶対禁止事項

- PDF 直リンクを url に格納する仕様
- PDF_ONLY で url を null にしない
- 1,737件の件数を変える
- 破壊的スキーマ変更
- 例外握り潰し
- ログ削除
- 大量 add や force push

---

## 15. 変更履歴

| Version | 内容                                                                                        |
| ------- | ------------------------------------------------------------------------------------------- |
| v1.0    | 初版                                                                                        |
| v1.1    | Stage 6 完了条件に内部AI監査30日安定稼働ルールの追加（公開RAG有効化の前提条件として強制化） |
